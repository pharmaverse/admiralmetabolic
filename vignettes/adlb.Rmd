---
title: "Creating a Laboratory Analysis Dataset (ADLB)"
output:
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Creating a Laboratory Analysis Dataset (ADLB)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(admiraldev)
```

# Introduction

This article describes creating a Laboratory Analysis Dataset (ADLB) for clinical trials.

We advise you first consult the `{admiral}` [Creating a BDS Finding ADaM vignette](https://pharmaverse.github.io/admiral/articles/bds_finding.html).
The programming workflow around creating the general set-up of an `ADLB` using `{admiral}` functions is the same. 
In this vignette, we focus on common ADLB derivations in metabolic studies and avoid repeating information and maintaining the same content in two places. 
As such, the code in this vignette is not completely executable - we recommend consulting the ADLB template script to view the full workflow.

**Note**: *All examples assume CDISC SDTM and/or ADaM format as input unless otherwise specified.*

## Required Packages

The examples of this vignette require the following packages.

```{r, warning=FALSE, message=FALSE}
library(admiral)
library(admiralmetabolic) # May still be needed for specific metabolic derivations if any
library(pharmaversesdtm)
library(dplyr)
library(stringr)
library(tidyr)
```

# Programming Workflow

-   [Read in Data](#readdata)
-   [Define Lookup Tables](#lookups)
-   [Derive Core ADLB Variables](#derive_core)
-   [Derive Visit Information](#derive_visits)
-   [Metabolic Parameters - Description](#metabolic_params_desc)
-   [Convert Lab Results](#convert)
-   [Merge ADVS and ADSL variables](#merge)
-   [Derive Metabolic Parameters](#derive_metabolic)
-   [Derive Metabolic Parameters using Functions](#derive_metabolic_functions)
-   [Remaining ADLB Set-up](#adlb_end)

## Read in Data {#readdata}

To start, all data frames needed for the creation of the ADaM dataset should be loaded into the global environment. Reading data will usually be a company specific process, however, for the purpose of this vignette, we will use example data from `{pharmaversesdtm}` and `{admiral}`. We will utilize `DM`, `LB` and `ADSL`.

```{r, message=FALSE, warning=FALSE}
dm_metabolic <- pharmaversesdtm::dm_metabolic
lb_metabolic <- pharmaversesdtm::lb_metabolic # Use lb_metabolic
admiral_adsl <- admiral::admiral_adsl

dm <- convert_blanks_to_na(dm_metabolic)
lb <- convert_blanks_to_na(lb_metabolic) # Use lb_metabolic
admiral_adsl <- convert_blanks_to_na(admiral_adsl)
```

Within this vignette, `DM` is used as the basis for `ADSL`:

```{r eval=TRUE}
# Retrieve required variables from admiral ADSL for this vignette that are not present in DM dataset
adsl <- dm %>%
  select(-DOMAIN) %>%
  mutate(TRT01P = ARM, TRT01A = ACTARM) %>%
  derive_vars_merged(
    dataset_add = admiral_adsl,
    by_vars = get_admiral_option("subject_keys"),
    new_vars = exprs(TRTSDT, TRTEDT)
  )

# Keep only required ADSL variables for derivations
adsl_vars <- exprs(TRTSDT, TRTEDT, TRT01A, TRT01P)
```

## Define Lookup Tables {#lookups}

Define parameter lookup table.

```{r}
# Assign PARAMCD, PARAM, and PARAMN
param_lookup <- tibble::tribble(
  ~LBTESTCD, ~PARAMCD, ~PARAM, ~PARAMN,
  "ALB", "ALB", "Albumin (g/L)", 1,
  "ALP", "ALKPH", "Alkaline Phosphatase (U/L)", 2,
  "AST", "AST", "Aspartate Aminotransferase (U/L)", 3,
  "CHOL", "CHOLES", "Cholesterol (mmol/L)", 4,
  "GGT", "GGT", "Gamma Glutamyl Transferase (U/L)", 5,
  "GLUC", "GLUC", "Glucose (mmol/L)", 6,
  "HBA1CHGB", "HBA1CHGB", "Hemoglobin A1C/Hemoglobin (%)", 7,
  "INSULIN", "INSULIN", "Insulin (pmol/L)", 8,
  "TRIG", "TRIG", "Triglycerides (mmol/L)", 9
)
```

## Derive Core ADLB Variables {#derive_core}

The basic parameters and timing variables can be derived similarly to other BDS finding ADaMs.

```{r}
adlb <- lb %>%
  ungroup() %>%
  # Join ADSL with LB (need TRTSDT for ADY derivation)
  derive_vars_merged(
    dataset_add = adsl,
    new_vars = adsl_vars,
    by_vars = get_admiral_option("subject_keys")
  ) %>%
  ## Calculate ADT, ADY ----
  derive_vars_dt(
    new_vars_prefix = "A",
    dtc = LBDTC
  ) %>%
  derive_vars_dy(reference_date = TRTSDT, source_vars = exprs(ADT))

adlb <- adlb %>%
  ## Add PARAMCD PARAM and PARAMN - from LOOK-UP table ----
  derive_vars_merged_lookup(
    dataset_add = param_lookup,
    new_vars = exprs(PARAMCD, PARAM, PARAMN),
    by_vars = exprs(LBTESTCD),
    check_type = "none", # Set to "warning" or "error" if you want checks
    print_not_mapped = FALSE # Set to TRUE to see unmapped LBTESTCDs
  ) %>%
  ## Calculate PARCAT1 AVAL AVALC ANRLO ANRHI ----
  mutate(
    PARCAT1 = LBCAT,
    AVAL = LBSTRESN,
    # Only populate AVALC if character value is non-redundant with AVAL
    AVALC = if_else(
      is.na(LBSTRESN) | as.character(LBSTRESN) != LBSTRESC,
      LBSTRESC,
      NA_character_
    ),
    ANRLO = LBSTNRLO,
    ANRHI = LBSTNRHI
  )
```

```{r echo=FALSE}
# Example display of derived data
dataset_vignette(
  arrange(adlb, USUBJID, PARCAT1, ADY, PARAMN),
  display_vars = exprs(!!!get_admiral_option("subject_keys"), ADT, ADY, PARAMCD, PARAM, PARAMN, PARCAT1, AVAL, AVALC, ANRLO, ANRHI)
)
```

## Derive Visit Information {#derive_visits}

Derive Analysis Visit (AVISIT) and Analysis Visit Number (AVISITN).

```{r}
adlb <- adlb %>%
  # Derive Timing
  mutate(
    AVISIT = case_when(
      str_detect(VISIT, "SCREEN") ~ "Baseline",
      !is.na(VISIT) ~ str_to_title(VISIT),
      TRUE ~ NA_character_
    ),
    AVISITN = case_when(
      AVISIT == "Baseline" ~ 0,
      str_detect(VISIT, "WEEK") ~ as.integer(str_extract(VISIT, "\\d+")),
      TRUE ~ NA_integer_
    )
  )
```

```{r echo=FALSE}
# Example display of derived data
dataset_vignette(
  arrange(adlb, USUBJID, PARCAT1, ADY, PARAMN),
  display_vars = exprs(!!!get_admiral_option("subject_keys"), PARAMCD, PARAM, PARCAT1, AVAL, ADY, AVISIT, AVISITN)
)
```

For deriving visits based on time-windows, see `{admiral}` [Visit and Period Variables](https://pharmaverse.github.io/admiral/articles/visits_periods.html).

## Metabolic Parameters - Description {#metabolic_params_desc}

In addition to the core ADLB variables, several metabolic parameters and scores will be derived based on laboratory data, vital signs, and subject-level information. These derivations include:

*   **Hepatic Steatosis Index (HSI)**: Derived from ALT (U/L), AST (U/L), BMI (kg/m2), T2DM status, and sex.
$$ HSI = 8 \times \left(\frac{ALT}{AST}\right) + BMI + 2 \text{ if T2DM present} + 2 \text{ if female.} $$
HSI is interpreted as a score with typical values between 16 and 60, where higher values indicate a worse condition.

*   **Fatty Liver Index (FLI)**: Derived from triglycerides (mg/dL), GGT (U/L), BMI (kg/m2), and waist circumference (cm).
 $$ FLI = \left[\frac{\exp(\lambda)}{1 + \exp(\lambda)}\right] \times 100 $$
where $$ \lambda = 0.953 \times \ln (\text{triglycerides}) + 0.139 \times BMI + 0.718 \times \ln (GGT) + 0.053 \times \text{waist circumference} – 15.745. $$
FLI is interpreted as a score between 0 and 100, where higher values indicate a worse condition.

*   **NAFLD (Non-Alcoholic Fatty Liver Disease) Fibrosis Score**: Derived from ALT (U/L), AST (U/L), Platelets (x 10^9/L), Albumin (g/dL), age, BMI (kg/m2), and T2DM status.
$$ \text{NAFLD fibrosis score} = -1.675 + 0.037 \times \text{age} + 0.094 \times BMI + 1.13 \text{ if T2DM present} + 0.99 \times \frac{AST}{ALT} – 0.013 \times \text{platelets} – 0.66 \times \text{albumin}. $$
Age at screening will be used and will not be re-calculated during the trial.

*   **Homeostasis Model Assessment – Insulin Resistance (HOMA-IR)**: Calculated from fasting plasma glucose (mmol/L) and fasting plasma insulin (mIU/L).
$$ \text{HOMA-IR} = \frac{FPI \times FPG}{22.5}. $$

To derive these parameters and scores, the following variables will be needed:

*   From ADLB: ALT, AST, TRIG (Triglycerides), GGT, PLAT (Platelets), ALB (Albumin), GLUC (fasted), INSULIN (fasted).
*   From ADVS: BMI, WSTCIR (Waist Circumference).
*   From ADSL: AGE, SEX, T2DM.

Note that some units may need conversion for the calculations (e.g., Triglycerides from mmol/L to mg/dL (FLI), Albumin from g/L to g/dL (NAFLD), Insulin from pmol/L to mIU/L (HOMA-IR)).

## Convert Lab Results {#convert}
```{r}
# Convert units for specific parameters
adlb_converted <- adlb %>%
  filter(PARAMCD %in% c("TRIG", "ALB", "INSULIN")) %>%
  mutate(
    AVAL = case_when(
      PARAMCD == "TRIG" ~ AVAL * 88.57, # mmol/L to mg/dL
      PARAMCD == "ALB" ~ AVAL / 10, # g/L to g/dL
      PARAMCD == "INSULIN" ~ AVAL * 0.16667 # pmol/L to mIU/L
    ),
    PARAMCD = case_when(
      PARAMCD == "TRIG" ~ "TRIGMG",
      PARAMCD == "ALB" ~ "ALBDL",
      PARAMCD == "INSULIN" ~ "INSULMIU"
    ),
    PARAM = case_when(
      PARAMCD == "TRIGMG" ~ "Triglycerides (mg/dL)",
      PARAMCD == "ALBDL" ~ "Albumin (g/dL)",
      PARAMCD == "INSULMIU" ~ "Insulin (mIU/L)"
    ),
    PARAMN = case_when(
      PARAMCD == "TRIGMG" ~ 10,
      PARAMCD == "ALBDL" ~ 11,
      PARAMCD == "INSULMIU" ~ 12
    )
  )

# Combine original ADLB with converted records
adlb <- bind_rows(adlb, adlb_converted) %>%
  arrange(STUDYID, USUBJID, ADT, PARAMN) # Arrange for consistency
```

## Merge ADVS and ADSL variables {#merge}

```{r}
# Add randomly assigned ALT and Platelets values for demonstration
# This will be replaced later with actual data
adlb_random_lab <- adlb %>%
  select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY) %>%
  distinct() %>%
  mutate(
    AVAL = case_when(
      TRUE ~ round(runif(n(), min = 10, max = 50), 1) # Random ALT values
    ),
    PARAMCD = "ALT",
    PARAM = "Alanine Aminotransferase (U/L)",
    PARAMN = 13
  ) %>%
  bind_rows(
    adlb %>%
      select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY) %>%
      distinct() %>%
      mutate(
        AVAL = case_when(
          TRUE ~ round(runif(n(), min = 150, max = 400), 0) # Random Platelets values
        ),
        PARAMCD = "PLAT",
        PARAM = "Platelets (x 10^9/L)",
        PARAMN = 14
      )
  )

adlb <- bind_rows(adlb, adlb_random_lab) %>%
  arrange(STUDYID, USUBJID, ADT, PARAMN) # Arrange for consistency


# Load ADVS dataset (assuming it has been created by ad_advs.R)
advs <- admiralmetabolic::admiralmetabolic_advs
advs <- convert_blanks_to_na(advs)

# Add temporary T2DM flag to ADSL for demonstration
# This will be replaced later with actual data
adsl_temp <- adsl %>%
  mutate(T2DM = sample(c("Y", "N"), n(), replace = TRUE)) # Assign randomly for now

# Merge AGE, SEX, and temporary T2DM from ADSL to ADLB
adlb <- adlb %>%
  derive_vars_merged(
    dataset_add = adsl_temp,
    by_vars = get_admiral_option("subject_keys"),
    new_vars = exprs(AGE, SEX, T2DM)
  )

# Select BMI and WSTCIR from ADVS and reshape for merging
advs_subset <- advs %>%
  filter(PARAMCD %in% c("BMI", "WSTCIR")) %>%
  select(STUDYID, USUBJID, ADT, PARAMCD, AVAL) %>%
  pivot_wider(
    names_from = PARAMCD,
    values_from = AVAL
  )

# Merge BMI and WSTCIR from ADVS to ADLB based on subject and date
adlb <- adlb %>%
  derive_vars_merged(
    dataset_add = advs_subset,
    by_vars = exprs(!!!get_admiral_option("subject_keys"), ADT),
    new_vars = exprs(BMI, WSTCIR)
  )
```

```{r echo=FALSE}
# Example display of derived data
dataset_vignette(
  arrange(adlb, USUBJID, ADY, PARAMN),
  display_vars = exprs(!!!get_admiral_option("subject_keys"), PARAMCD, PARAM, AVAL, ADY, AVISIT, AVISITN, AGE, SEX, T2DM, BMI, WSTCIR)
)
```

## Derive Metabolic Parameters {#derive_metabolic}

```{r}
# Pivot required parameters to wide format for score calculation
adlb_wide <- adlb %>%
  filter(PARAMCD %in% c("ALT", "AST", "TRIGMG", "GGT", "PLAT", "ALBDL", "GLUC", "INSULMIU")) %>% # Include LB parameters
  select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY, PARAMCD, AVAL) %>%
  pivot_wider(
    names_from = PARAMCD,
    values_from = AVAL
  ) %>%
  # Join with the ADLB data that already has BMI, WSTCIR, AGE, SEX, T2DM
  derive_vars_merged(
    dataset_add = adlb %>% distinct(STUDYID, USUBJID, ADT, BMI, WSTCIR, AGE, SEX, T2DM),
    by_vars = exprs(!!!get_admiral_option("subject_keys"), ADT)
  ) %>%
  # Calculate scores
  mutate(
    # HSI = 8 x (ALT/AST) + BMI + 2 if T2DM present + 2 if female
    HSI_AVAL = case_when(
      !is.na(ALT) & !is.na(AST) & !is.na(BMI) ~
        8 * (ALT / AST) + BMI + if_else(T2DM == "Y", 2, 0) + if_else(SEX == "F", 2, 0)
    ),
    # FLI = [exp(lambda)/(1 + exp(lambda))] x 100
    # lambda = 0.953 x ln (triglycerides) + 0.139 x BMI + 0.718 x ln (GGT) + 0.053 x waist circumference – 15.745
    FLI_AVAL = case_when(
      !is.na(TRIGMG) & !is.na(BMI) & !is.na(GGT) & !is.na(WSTCIR) ~ {
        lambda <- 0.953 * log(TRIGMG) + 0.139 * BMI + 0.718 * log(GGT) + 0.053 * WSTCIR - 15.745
        (exp(lambda) / (1 + exp(lambda))) * 100
      }
    ),
    # NAFLD fibrosis score = -1.675 + 0.037 x age + 0.094 x BMI + 1.13 if T2DM present + 0.99 x AST/ALT – 0.013 x Platelets – 0.66 x Albumin.
    NAFLDFS_AVAL = case_when(
      !is.na(AGE) & !is.na(BMI) & !is.na(AST) & !is.na(ALT) & !is.na(PLAT) & !is.na(ALBDL) ~
        -1.675 + 0.037 * AGE + 0.094 * BMI + if_else(T2DM == "Y", 1.13, 0) +
        0.99 * (AST / ALT) - 0.013 * PLAT - 0.66 * ALBDL
    ),
    # HOMA-IR = (FPI * FPG) / 22.5
    HOMA_IR_AVAL = case_when(
      !is.na(INSULMIU) & !is.na(GLUC) ~ (INSULMIU * GLUC) / 22.5
    )
  ) %>%
  # Select only the score variables and key identifiers
  select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY, HSI_AVAL, FLI_AVAL, NAFLDFS_AVAL, HOMA_IR_AVAL) %>%
  # Reshape back to long format for merging with original ADLB
  pivot_longer(
    cols = ends_with("_AVAL"),
    names_to = "PARAMCD_temp",
    values_to = "AVAL"
  ) %>%
  mutate(
    PARAMCD = case_when(
      PARAMCD_temp == "HSI_AVAL" ~ "HSI",
      PARAMCD_temp == "FLI_AVAL" ~ "FLI",
      PARAMCD_temp == "NAFLDFS_AVAL" ~ "NAFLDFS",
      PARAMCD_temp == "HOMA_IR_AVAL" ~ "HOMAIR"
    ),
    PARAM = case_when(
      PARAMCD == "HSI" ~ "Hepatic Steatosis Index",
      PARAMCD == "FLI" ~ "Fatty Liver Index",
      PARAMCD == "NAFLDFS" ~ "NAFLD Fibrosis Score",
      PARAMCD == "HOMAIR" ~ "Homeostasis Model Assessment - Insulin Resistance"
    ),
    PARAMN = case_when(
      PARAMCD == "HSI" ~ 15,
      PARAMCD == "FLI" ~ 16,
      PARAMCD == "NAFLDFS" ~ 17,
      PARAMCD == "HOMAIR" ~ 18 # Assign a new PARAMN
    )
  ) %>%
  filter(!is.na(AVAL)) %>% # Keep only derived score records
  select(-PARAMCD_temp)

# Combine derived scores with original ADLB data
adlb1 <- bind_rows(adlb, adlb_wide) %>%
  arrange(STUDYID, USUBJID, ADT, PARAMN) # Arrange for consistency
```

```{r echo=FALSE}
# Example display of derived data
dataset_vignette(
  arrange(adlb1, USUBJID, ADY, PARAMN),
  display_vars = exprs(!!!get_admiral_option("subject_keys"), PARAMCD, PARAM, AVAL, ADY, AVISIT, AVISITN)
)
```
## Derive Metabolic Parameters using Functions {#derive_metabolic_functions}

```{r}
# Derive Metabolic Parameters using Functions
# Start with the adlb dataset (after merging ADSL and ADVS variables)

adlb_scores <- adlb %>%
  filter(PARAMCD %in% c("ALT", "AST", "TRIGMG", "GGT", "PLAT", "ALBDL", "GLUC", "INSULMIU")) %>% # Include LB parameters
  select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY, PARAMCD, AVAL, AGE, SEX, T2DM, BMI, WSTCIR) %>% # Include necessary variables for compute functions
  pivot_wider(
    names_from = PARAMCD,
    values_from = AVAL
  ) %>%
  # Calculate scores using functions
  mutate(
    HSI_AVAL = compute_metabolic_score(mode = "HSI", alt = ALT, ast = AST, bmi = BMI, t2dm = T2DM, sex = SEX),
    FLI_AVAL = compute_metabolic_score(mode = "FLI", triglycerides = TRIGMG, ggt = GGT, bmi = BMI, waist_circumference = WSTCIR),
    NAFLDFS_AVAL = compute_metabolic_score(mode = "NAFLDFS", alt = ALT, ast = AST, platelets = PLAT, albumin = ALBDL, age = AGE, bmi = BMI, t2dm = T2DM),
    HOMA_IR_AVAL = compute_metabolic_score(mode = "HOMAIR", glucose = GLUC, insulin = INSULMIU)
  ) %>%
  # Select only the score variables and key identifiers
  select(STUDYID, USUBJID, AVISIT, AVISITN, ADT, ADY, HSI_AVAL, FLI_AVAL, NAFLDFS_AVAL, HOMA_IR_AVAL) %>%
  # Reshape back to long format
  pivot_longer(
    cols = ends_with("_AVAL"),
    names_to = "PARAMCD_temp",
    values_to = "AVAL"
  ) %>%
  mutate(
    PARAMCD = case_when(
      PARAMCD_temp == "HSI_AVAL" ~ "HSI",
      PARAMCD_temp == "FLI_AVAL" ~ "FLI",
      PARAMCD_temp == "NAFLDFS_AVAL" ~ "NAFLDFS",
      PARAMCD_temp == "HOMA_IR_AVAL" ~ "HOMAIR"
    ),
    PARAM = case_when(
      PARAMCD == "HSI" ~ "Hepatic Steatosis Index",
      PARAMCD == "FLI" ~ "Fatty Liver Index",
      PARAMCD == "NAFLDFS" ~ "NAFLD Fibrosis Score",
      PARAMCD == "HOMAIR" ~ "Homeostasis Model Assessment - Insulin Resistance"
    ),
    PARAMN = case_when(
      PARAMCD == "HSI" ~ 15,
      PARAMCD == "FLI" ~ 16,
      PARAMCD == "NAFLDFS" ~ 17,
      PARAMCD == "HOMAIR" ~ 18 # Assign a new PARAMN
    )
  ) %>%
  filter(!is.na(AVAL)) %>% # Keep only derived score records
  select(-PARAMCD_temp)

# Combine derived scores with the adlb2 dataset (which contains original data and merged variables)
adlb2 <- bind_rows(adlb, adlb_scores) %>%
  arrange(STUDYID, USUBJID, ADT, PARAMN) # Arrange for consistency
```

```{r echo=FALSE}
# Example display of derived data
dataset_vignette(
  arrange(adlb2, USUBJID, ADY, PARAMN),
  display_vars = exprs(!!!get_admiral_option("subject_keys"), PARAMCD, PARAM, AVAL, ADY, AVISIT, AVISITN)
)
```

## Remaining ADLB Set-up {#adlb_end}

The `{admiral}` [Creating a BDS Finding ADaM vignette](https://pharmaverse.github.io/admiral/articles/bds_finding.html) describes further steps, including how to calculate baseline and change from baseline variables, add analysis flags (e.g., `ANL01FL`), handle reference ranges, categorizations, and other common ADLB requirements.

# Example Scripts {#example}

ADaM | Sample Code
---- | --------------
ADLB | [ad_adlb.R](https://github.com/pharmaverse/admiralmetabolic/blob/main/inst/templates/ad_adlb.R){target="_blank"}
